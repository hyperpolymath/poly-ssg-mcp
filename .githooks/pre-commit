#!/bin/bash
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell

# polyglot-ssg-mcp Pre-commit Hook
# Enforces: ReScript YES, TypeScript NO

set -e

echo "=== polyglot-ssg-mcp Pre-commit Hook ==="

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

ERRORS=0

# Check for TypeScript files
echo -n "Checking for prohibited TypeScript files... "
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$TS_FILES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo ""
    echo -e "${RED}ERROR: TypeScript files are PROHIBITED!${NC}"
    echo "Use ReScript (.res) instead."
    echo ""
    echo "Prohibited files:"
    echo "$TS_FILES" | while read f; do echo "  - $f"; done
    ERRORS=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check ReScript compilation
echo -n "Checking ReScript compilation... "
RES_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.resi?$' || true)

if [ -n "$RES_FILES" ]; then
    if command -v npx &> /dev/null && [ -f "package.json" ]; then
        if ! npm run res:build > /dev/null 2>&1; then
            echo -e "${RED}FAILED${NC}"
            echo "Run 'npm run res:build' to see errors."
            ERRORS=1
        else
            echo -e "${GREEN}OK${NC}"
        fi
    else
        echo -e "${GREEN}SKIPPED${NC} (npm not available)"
    fi
else
    echo -e "${GREEN}OK${NC} (no ReScript files changed)"
fi

echo ""
if [ $ERRORS -ne 0 ]; then
    echo -e "${RED}Pre-commit checks FAILED.${NC}"
    exit 1
else
    echo -e "${GREEN}All checks passed!${NC}"
fi
